<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sakr Travel</title>
    <style>
        /* تصميم عام */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #eefbff;
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        .container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        button.check-in { background-color: #28a745; color: white; }
        button.check-out { background-color: #007bff; color: white; }
        button.clear { background-color: #dc3545; color: white; position: absolute; top: 10px; left: 10px; }
        button.history { background-color: #ffc107; color: black; position: absolute; top: 85px; left: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        table, th, td { border: 1px solid #ddd; text-align: center; padding: 12px; }
        th { background-color: #007bff; color: white; }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 10; }
        .modal-content { background: white; width: 80%; max-width: 600px; margin: 10% auto; padding: 20px; border-radius: 12px; }
        video { width: 250px; height: 250px; border: 2px dashed green; border-radius: 10px; }
        .scanner-container { text-align: center; margin-bottom: 20px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/html5-qrcode.min.js"></script>
</head>
<body>

<div class="container">
    <div class="logo">Sakr Travel</div>
    <button class="clear" onclick="clearList()">مسح الكل</button>
    <button class="history" onclick="openHistory()">التاريخ</button>
    <div class="button-row">
        <button class="check-in" onclick="startScan('checkIn')">تسجيل الدخول</button>
        <button class="check-out" onclick="startScan('checkOut')">Check Out</button>
    </div>
    <table id="studentsTable">
        <thead>
            <tr>
                <th>اسم الطالب</th>
                <th>وقت التسجيل</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="historyModal" class="modal">
    <div class="modal-content">
        <h2>تاريخ القوائم</h2>
        <button onclick="closeHistory()">إغلاق</button>
        <div id="historyContent"></div>
    </div>
</div>

<div id="scannerModal" class="modal">
    <div class="modal-content">
        <h2>مسح QR Code</h2>
        <div id="scannerPreview" class="scanner-container"></div>
        <button onclick="stopScanner()">إغلاق</button>
    </div>
</div>

<script>
    let students = [];
    let history = [];
    let qrScanner;

    function startScan(mode) {
        const scannerModal = document.getElementById("scannerModal");
        scannerModal.style.display = "block";

        const scannerContainer = document.getElementById("scannerPreview");
        scannerContainer.innerHTML = "";

        qrScanner = new Html5Qrcode("scannerPreview");
        qrScanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            result => {
                if (mode === "checkIn") handleCheckIn(result);
                else if (mode === "checkOut") handleCheckOut(result);
                stopScanner();
            },
            error => console.warn("خطأ في المسح:", error)
        );
    }

    function stopScanner() {
        if (qrScanner) qrScanner.stop();
        document.getElementById("scannerModal").style.display = "none";
    }

    function handleCheckIn(qrData) {
        const now = new Date();
        const formattedTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        const studentName = qrData.trim();
        if (!studentName) return alert("QR Code غير صالح.");

        if (students.some(s => s.name === studentName)) return alert(`الطالب "${studentName}" مسجل بالفعل.`);

        students.push({ name: studentName, checkIn: formattedTime });
        updateTable();
    }

    function handleCheckOut(qrData) {
        const studentName = qrData.trim();
        if (!studentName) return alert("QR Code غير صالح.");

        const index = students.findIndex(s => s.name === studentName);
        if (index === -1) return alert(`الطالب "${studentName}" غير مسجل.`);

        students.splice(index, 1);
        updateTable();
    }

    function updateTable() {
        const tableBody = document.querySelector("#studentsTable tbody");
        tableBody.innerHTML = students.map(s => `
            <tr>
                <td>${s.name}</td>
                <td>${s.checkIn}</td>
            </tr>
        `).join("");
    }

    function clearList() {
        if (students.length === 0) return alert("لا توجد بيانات للمسح.");

        history.push({ date: new Date().toLocaleDateString(), list: [...students] });
        students = [];
        updateTable();
    }

    function openHistory() {
        const historyContentDiv = document.getElementById("historyContent");
        historyContentDiv.innerHTML = history.length === 0
            ? "<p>لا يوجد تاريخ محفوظ.</p>"
            : history.map(day => `
                <h3>التاريخ: ${day.date}</h3>
                <table><thead><tr><th>اسم الطالب</th><th>وقت الدخول</th></tr></thead>
                <tbody>${day.list.map(s => `<tr><td>${s.name}</td><td>${s.checkIn}</td></tr>`).join("")}</tbody></table>
            `).join("");
        document.getElementById("historyModal").style.display = "block";
    }

    function closeHistory() { document.getElementById("historyModal").style.display = "none"; }

    window.onload = updateTable;
</script>

</body>
</html>
