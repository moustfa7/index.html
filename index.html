<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sakr Travel</title>
    <!-- QR Code Reader Library -->
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode/html5-qrcode.min.js"></script>
    <style>
        /* تصميم عام */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #eefbff;
            margin: 0;
            padding: 20px;
            text-align: center;
        }

        .container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        button.check-in { background-color: #28a745; color: white; }
        button.check-out { background-color: #007bff; color: white; }
        button.clear { background-color: #dc3545; color: white; position: absolute; top: 10px; left: 10px; }
        button.history { background-color: #ffc107; color: black; position: absolute; top: 85px; left: 10px; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table, th, td {
            border: 1px solid #ddd;
            text-align: center;
            padding: 12px;
        }

        th {
            background-color: #007bff;
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        .modal-content {
            background: white;
            width: 80%;
            max-width: 600px;
            margin: 10% auto;
            padding: 20px;
            border-radius: 12px;
        }

        video {
            width: 250px;
            height: 250px;
            border: 2px dashed green;
            border-radius: 10px;
        }

        .scanner-container {
            text-align: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- شعار Sakr Travel -->
    <div class="logo">Sakr Travel</div>

    <!-- زراير (مسح الكل، التاريخ، تسجيل الدخول، تسجيل الخروج) -->
    <button class="clear" onclick="clearList()">مسح الكل</button>
    <button class="history" onclick="openHistory()">التاريخ</button>
    <div class="button-row">
        <button class="check-in" onclick="startScan('checkIn')">تسجيل الدخول</button>
        <button class="check-out" onclick="startScan('checkOut')">تسجيل الخروج</button>
    </div>

    <!-- جدول الطلاب -->
    <table id="studentsTable">
        <thead>
            <tr>
                <th>اسم الطالب</th>
                <th>وقت الدخول</th>
                <th>حالة الخروج</th>
                <th>العودة</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- نافذة التاريخ -->
<div id="historyModal" class="modal">
    <div class="modal-content">
        <h2>تاريخ القوائم المحفوظة</h2>
        <button onclick="closeHistory()">إغلاق</button>
        <div id="historyContent"></div>
    </div>
</div>

<!-- نافذة المسح الضوئي -->
<div id="scannerModal" class="modal">
    <div class="modal-content">
        <h2>مسح QR Code</h2>
        <div id="scannerPreview" class="scanner-container"></div>
        <button onclick="stopScanner()">إغلاق</button>
    </div>
</div>

<script>
    let students = [];
    let history = [];
    let qrScanner;

    // بدء المسح الضوئي
    function startScan(mode) {
        const scannerModal = document.getElementById("scannerModal");
        scannerModal.style.display = "block";

        const scannerContainer = document.getElementById("scannerPreview");

        // إزالة العناصر السابقة
        while (scannerContainer.firstChild) {
            scannerContainer.removeChild(scannerContainer.firstChild);
        }

        // تهيئة المسح الضوئي
        try {
            qrScanner = new Html5Qrcode("scannerPreview", {
                fps: 10,
                qrbox: { width: 250, height: 250 } // حجم منطقة المسح
            });

            // البدء في المسح
            qrScanner.render(result => {
                if (mode === "checkIn") {
                    handleCheckIn(result);
                } else if (mode === "checkOut") {
                    handleCheckOut(result);
                }
                stopScanner(); // إيقاف المسح بعد قراءة الرمز
            });
        } catch (error) {
            alert("حدث خطأ أثناء تهيئة الكاميرا.");
            console.error("QR Scanner initialization error:", error);
        }
    }

    // إيقاف المسح الضوئي
    function stopScanner() {
        if (qrScanner) {
            qrScanner.clear().then(() => {
                qrScanner = null;
            }).catch(error => {
                console.error("Error stopping scanner:", error);
            });
        }
        const scannerModal = document.getElementById("scannerModal");
        scannerModal.style.display = "none";
    }

    // معالجة تسجيل الدخول
    function handleCheckIn(qrData) {
        const now = new Date();
        const formattedTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); // تنسيق الوقت

        const studentName = qrData.trim(); // إزالة الفراغات

        if (!studentName) {
            vibrateAndNotify("red", "QR Code غير صالح.");
            return;
        }

        // التحقق من وجود الطالب بالفعل
        if (students.some(s => s.name === studentName)) {
            vibrateAndNotify("red", `الطالب "${studentName}" مسجل بالفعل.`);
            return;
        }

        // إضافة الطالب إلى القائمة
        students.push({ name: studentName, checkIn: formattedTime, checkOut: "", returnTime: "" });
        updateTable();
        vibrateAndNotify("green", `تم تسجيل دخول الطالب "${studentName}" بنجاح.`);
    }

    // معالجة تسجيل الخروج
    function handleCheckOut(qrData) {
        const studentName = qrData.trim(); // إزالة الفراغات

        if (!studentName) {
            vibrateAndNotify("red", "QR Code غير صالح.");
            return;
        }

        // البحث عن الطالب في القائمة
        const index = students.findIndex(s => s.name === studentName && !s.checkOut);

        if (index === -1) {
            vibrateAndNotify("red", `لم يتم العثور على الطالب "${studentName}" أو أنه سجل خروجه بالفعل.`);
            return;
        }

        // تحديث حالة الخروج للطالب
        students[index].checkOut = "<span class='check-out-icon'>✅</span>";
        updateTable();
        vibrateAndNotify("green", `تم تسجيل خروج الطالب "${studentName}" بنجاح.`);
    }

    // تحديث الجدول
    function updateTable() {
        const tableBody = document.querySelector("#studentsTable tbody");
        tableBody.innerHTML = students.map((student, index) => `
            <tr>
                <td>${student.name}</td>
                <td>${student.checkIn || "-"}</td>
                <td>${student.checkOut || "-"}</td>
                <td><input class="return-time" type="text" value="${student.returnTime}" onchange="updateReturnTime(${index}, this.value)" /></td>
            </tr>
        `).join("");
    }

    // تحديث وقت العودة
    function updateReturnTime(index, value) {
        if (value.length > 5) {
            alert("يجب أن يكون وقت العودة على شكل 12:30 فقط.");
            return;
        }

        students[index].returnTime = value;
        updateTable();
    }

    // مسح القائمة الحالية وإضافة نسخة منها إلى التاريخ
    function clearList() {
        if (students.length === 0) {
            vibrateAndNotify("red", "لا توجد بيانات للمسح.");
            return;
        }

        const currentDate = new Date().toLocaleDateString();
        history.push({ date: currentDate, list: [...students] });
        students = [];
        updateTable();
        vibrateAndNotify("green", "تم مسح القائمة الحالية بنجاح.");
    }

    // عرض التاريخ
    function openHistory() {
        const historyContentDiv = document.getElementById("historyContent");
        historyContentDiv.innerHTML = history.length === 0
            ? "<p>لا يوجد تاريخ محفوظ.</p>"
            : history.map(day => `
                <h3>التاريخ: ${day.date}</h3>
                <table>
                    <thead>
                        <tr>
                            <th>اسم الطالب</th>
                            <th>وقت الدخول</th>
                            <th>حالة الخروج</th>
                            <th>العودة</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${day.list.map(student => `
                            <tr>
                                <td>${student.name}</td>
                                <td>${student.checkIn || "-"}</td>
                                <td>${student.checkOut || "-"}</td>
                                <td>${student.returnTime || "-"}</td>
                            </tr>
                        `).join("")}
                    </tbody>
                </table>
            `).join("");

        document.getElementById("historyModal").style.display = "block";
    }

    // إغلاق نافذة التاريخ
    function closeHistory() {
        document.getElementById("historyModal").style.display = "none";
    }

    // هز الهاتف وإشعار المستخدم
    function vibrateAndNotify(color, message) {
        if (color === "green") {
            navigator.vibrate(100); // هز قصير عند النجاح
            new Audio("https://notificationsounds.com/download-sound.php?id=10&type=mp3").play(); // صوت نجاح
        } else if (color === "red") {
            navigator.vibrate(500); // هز طويل عند الخطأ
        }

        alert(message); // عرض رسالة التنبيه
    }

    // تحميل الصفحة وتحديث الجدول
    window.onload = updateTable;
</script>

</body>
</html>
