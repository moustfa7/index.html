<script>
    let students = [];
    let history = [];
    let qrScanner;

    function startScan(mode) {
        const scannerModal = document.getElementById("scannerModal");
        scannerModal.style.display = "block";

        const scannerContainer = document.getElementById("scannerPreview");
        scannerContainer.innerHTML = "";

        qrScanner = new Html5Qrcode("scannerPreview");
        qrScanner.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            result => {
                // **مسح الكود تلقائيًا بعد القراءة**
                qrScanner.stop().then(() => {
                    document.getElementById("scannerPreview").innerHTML = "";
                    if (mode === "checkIn") handleCheckIn(result);
                    else if (mode === "checkOut") handleCheckOut(result);
                    stopScanner();
                }).catch(err => console.error("خطأ عند إيقاف الماسح:", err));
            },
            error => console.warn("خطأ في المسح:", error)
        );
    }

    function stopScanner() {
        if (qrScanner) qrScanner.stop();
        document.getElementById("scannerModal").style.display = "none";
    }

    function handleCheckIn(qrData) {
        const now = new Date();
        const formattedTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        const studentName = qrData.trim();
        if (!studentName) return alert("QR Code غير صالح.");

        if (students.some(s => s.name === studentName)) return alert(`الطالب "${studentName}" مسجل بالفعل.`);

        students.push({ name: studentName, checkIn: formattedTime });
        updateTable();
    }

    function handleCheckOut(qrData) {
        const studentName = qrData.trim();
        if (!studentName) return alert("QR Code غير صالح.");

        const index = students.findIndex(s => s.name === studentName);
        if (index === -1) return alert(`الطالب "${studentName}" غير مسجل.`);

        students.splice(index, 1);
        updateTable();
    }

    function updateTable() {
        const tableBody = document.querySelector("#studentsTable tbody");
        tableBody.innerHTML = students.map(s => `
            <tr>
                <td>${s.name}</td>
                <td>${s.checkIn}</td>
            </tr>
        `).join("");
    }
</script>
