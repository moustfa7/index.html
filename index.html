let students = [];
let history = [];
let qrScanner = null;

function startScan(mode) {
    const scannerModal = document.getElementById("scannerModal");
    scannerModal.style.display = "block";

    const videoElement = document.getElementById("scannerPreview");
    qrScanner = new QRScanner(videoElement, result => {
        if (mode === "checkIn") {
            handleCheckIn(result.data);
        } else if (mode === "checkOut") {
            handleCheckOut(result.data);
        }
        stopScanner();
    });

    qrScanner.start();
}

function stopScanner() {
    if (qrScanner) {
        qrScanner.stop();
        qrScanner = null;
    }
    const scannerModal = document.getElementById("scannerModal");
    scannerModal.style.display = "none";
}

function handleCheckIn(qrData) {
    const now = new Date();
    const formattedTime = now.toLocaleString();

    const studentName = qrData || "طالب جديد";
    const existingStudent = students.find(student => student.name === studentName);

    if (existingStudent && !existingStudent.checkOut) {
        alert(`الطالب "${studentName}" مسجل بالفعل.`);
        return;
    }

    const student = { name: studentName, checkIn: formattedTime, checkOut: "", notes: "" };
    students.push(student);
    updateTable();
}

function handleCheckOut(qrData) {
    const studentName = qrData;
    const student = students.find(s => s.name === studentName && !s.checkOut);

    if (!student) {
        alert(`لم يتم العثور على الطالب "${studentName}" أو أنه سجل خروجه بالفعل.`);
        return;
    }

    const now = new Date();
    student.checkOut = "<span class='check-out-icon'>✅</span>";
    updateTable();
}

function updateTable() {
    const tableBody = document.querySelector("#studentsTable tbody");
    tableBody.innerHTML = "";
    students.forEach((student, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${student.name}</td>
            <td>${student.checkIn || "-"}</td>
            <td>${student.checkOut || "-"}</td>
            <td><input type="text" value="${student.notes}" onchange="updateNotes(${index}, this.value)" /></td>
        `;
        tableBody.appendChild(row);
    });
}

function clearList() {
    if (students.length > 0) {
        const currentDate = new Date().toLocaleDateString();
        history.push({ date: currentDate, list: [...students] });
        students = [];
        updateTable();
    } else {
        alert("لا توجد قائمة للمسح.");
    }
}

function openHistory() {
    const historyContentDiv = document.getElementById("historyContent");
    historyContentDiv.innerHTML = "";

    if (history.length === 0) {
        historyContentDiv.innerHTML = "<p>لا يوجد تاريخ محفوظ.</p>";
    } else {
        history.forEach((day, index) => {
            const dayDiv = document.createElement("div");
            dayDiv.style.marginBottom = "20px";
            dayDiv.innerHTML = `
                <h3>التاريخ: ${day.date}</h3>
                <table>
                    <thead>
                        <tr>
                            <th>اسم الطالب</th>
                            <th>وقت الدخول</th>
                            <th>حالة الخروج</th>
                            <th>ملاحظات</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${day.list.map(stud => `
                            <tr>
                                <td>${stud.name}</td>
                                <td>${stud.checkIn || "-"}</td>
                                <td>${stud.checkOut || "-"}</td>
                                <td>${stud.notes || "-"}</td>
                            </tr>
                        `).join("")}
                    </tbody>
                </table>
            `;
            historyContentDiv.appendChild(dayDiv);
        });
    }

    document.getElementById("historyModal").style.display = "block";
}

function closeHistory() {
    document.getElementById("historyModal").style.display = "none";
}

function updateNotes(index, value) {
    students[index].notes = value;
}
